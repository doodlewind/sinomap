var Sinomap=function(){"use strict";function t(t,n){var e=E*t*S,r=Math.max(Math.min(b,n),-b)*S;return r=E*Math.log(Math.tan(Math.PI/4+r/2)),[e,r]}function n(n){var e=[];return n.features.forEach(function(n){"Polygon"===n.geometry.type?n.geometry.coordinates.forEach(function(n){e=e.concat(n.map(function(n){return t(n[0],n[1])}))}):n.geometry.coordinates.forEach(function(n){n.forEach(function(n){e=e.concat(n.map(function(n){return t(n[0],n[1])}))})})}),e}function e(t){var n=t.reduce(function(t,n){return t[0]<n[0]?t:n})[0],e=t.reduce(function(t,n){return t[0]>n[0]?t:n})[0],r=t.reduce(function(t,n){return t[1]<n[1]?t:n})[1];return{w:e-n,h:t.reduce(function(t,n){return t[1]>n[1]?t:n})[1]-r,minX:n,minY:r}}function r(t,n){var e=w(t,2),r=e[0],i=e[1],a=w(n,2),o=a[0],h=a[1],s=r/i/(o/h)>1,c=s?o/r:h/i;return[s?0:(o-r*c)/2,s?(h-i*c)/2:0,c]}function i(n,e,r){return r.map(function(r){var i=t(r[0],r[1]),a=w(i,2),o=a[0],h=a[1];return[o-n,h-e]})}function a(t,i,a){var o=n(t),h=e(o),s=r([h.w,h.h],[i,a]),c=w(s,3),u=c[0],f=c[1],l=c[2];return{offsetX:u,offsetY:f,minX:h.minX,minY:h.minY,areaScale:l}}function o(t,n,e,r,a,o,h){return i(n,e,[t]).map(function(t){return[t[0]*o+r,h-t[1]*o-a]})[0]}function h(t,n,e,r,a,o,h){return i(n,e,t).map(function(t){return[t[0]*o+r,h-t[1]*o-a]})}function s(){var t=this,n=Array.from(arguments),e=n.splice(0,1);this.layers.forEach(function(r){r[e]&&r[e].apply(r,[t].concat(C(n)))})}function c(t,n){var e=n.features.filter(function(n){return n.properties.name===t});if(e.length)return e[0].properties}function u(){var t="devicePixelRatio";return t in window&&window[t]>1?window[t]:1}function f(t,n,e){var r=document.createElement("canvas");return r.width=t*e,r.height=n*e,r.style.width=t+"px",r.style.height=n+"px",r.getContext("2d").scale(e,e),r}function l(t){var n=this;t.addEventListener("mousemove",function(t){var e=n.mapCanvas.getBoundingClientRect();n.mouseX=(t.clientX-e.left)*n.mapCanvas.width/e.width,n.mouseY=(t.clientY-e.top)*n.mapCanvas.height/e.height,n.updateMap()})}function m(t,n){var e=this.renderConf,r=h(t,e.minX,e.minY,e.offsetX,e.offsetY,e.areaScale,this.height);this.ctx.fillStyle=this.color,this.ctx.strokeStyle=this.borderColor,d(this.ctx,r),this.ctx.stroke(),this.callLayer("afterAreaDraw",r,n);var i=this.ctx.isPointInPath(this.mouseX,this.mouseY);return i&&(this.callLayer("onAreaHover",r,n),this.hoverName!==n.name&&(null!==this.hoverName&&this.callLayer("onAreaLeave",n),this.callLayer("onAreaEnter",n),this.hoverName=n.name)),i}function v(t){var n=this.renderConf;return o(t,n.minX,n.minY,n.offsetX,n.offsetY,n.areaScale,this.height)}function d(t,n){n.forEach(function(e,r){var i=[n[r][0],n[r][1]],a=i[0],o=i[1];0===r&&t.beginPath(),t.lineTo(a,o)}),t.closePath(),t.fill()}function p(t,n,e){var r="string"==typeof this.el?document.querySelector(this.el):this.el;if(!r)throw new Error("[Sinomap] Target element not found.");this.mouseX=0,this.mouseY=0,this.hoverName=null,this.canvasScale=u(),this.mapCanvas=f(this.width,this.height,this.canvasScale),this.ctx=this.mapCanvas.getContext("2d"),this.utils={drawPath:d,convert:v.bind(this)},r.appendChild(this.mapCanvas),l.bind(this)(this.mapCanvas)}function y(){var t=m.bind(this);this.renderConf=a(this.geoJSON,this.width,this.height);var n=!1;this.geoJSON.features.forEach(function(e){"Polygon"===e.geometry.type?e.geometry.coordinates.forEach(function(r){t(r,e.properties)&&(n=!0)}):e.geometry.coordinates.forEach(function(r){return r.forEach(function(r){t(r,e.properties)&&(n=!0)})})}),n||null===this.hoverName||(this.callLayer("onAreaLeave",c(this.hoverName,this.geoJSON)),this.hoverName=null),this.callLayer("afterMapDraw")}var g=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")},w=function(){function t(t,n){var e=[],r=!0,i=!1,a=void 0;try{for(var o,h=t[Symbol.iterator]();!(r=(o=h.next()).done)&&(e.push(o.value),!n||e.length!==n);r=!0);}catch(t){i=!0,a=t}finally{try{!r&&h.return&&h.return()}finally{if(i)throw a}}return e}return function(n,e){if(Array.isArray(n))return n;if(Symbol.iterator in Object(n))return t(n,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),C=function(t){if(Array.isArray(t)){for(var n=0,e=Array(t.length);n<t.length;n++)e[n]=t[n];return e}return Array.from(t)},E=6378137,b=85.0511287798,S=Math.PI/180,x={el:null,width:600,height:400,layers:[],color:"#ddd",hoverColor:"rgba(255, 255, 255, 0.5)",borderColor:"white",geoJSON:null};return function t(n){var e=this;g(this,t),this.updateMap=y.bind(this),this.callLayer=s.bind(this),n=Object.assign({},x,n),Object.keys(n).forEach(function(t){e[t]=n[t]}),p.bind(this)(),this.updateMap()}}();
