var Sinomap=function(){"use strict";function t(t,e){var n=S*t*x,r=Math.max(Math.min(b,e),-b)*x;return r=S*Math.log(Math.tan(Math.PI/4+r/2)),[n,r]}function e(e){var n=[];return e.features.forEach(function(e){"Polygon"===e.geometry.type?e.geometry.coordinates.forEach(function(e){n=n.concat(e.map(function(e){return t(e[0],e[1])}))}):e.geometry.coordinates.forEach(function(e){e.forEach(function(e){n=n.concat(e.map(function(e){return t(e[0],e[1])}))})})}),n}function n(t){var e=t.reduce(function(t,e){return t[0]<e[0]?t:e})[0],n=t.reduce(function(t,e){return t[0]>e[0]?t:e})[0],r=t.reduce(function(t,e){return t[1]<e[1]?t:e})[1];return{w:n-e,h:t.reduce(function(t,e){return t[1]>e[1]?t:e})[1]-r,minX:e,minY:r}}function r(t,e){var n=E(t,2),r=n[0],i=n[1],a=E(e,2),o=a[0],h=a[1],s=r/i/(o/h)>1,c=s?o/r:h/i;return[s?0:(o-r*c)/2,s?(h-i*c)/2:0,c]}function i(e,n,r){return r.map(function(r){var i=t(r[0],r[1]),a=E(i,2),o=a[0],h=a[1];return[o-e,h-n]})}function a(t,i,a){var o=e(t),h=n(o),s=r([h.w,h.h],[i,a]),c=E(s,3),u=c[0],f=c[1],l=c[2];return{offsetX:u,offsetY:f,minX:h.minX,minY:h.minY,areaScale:l}}function o(t,e,n,r,a,o,h){return i(e,n,[t]).map(function(t){return[t[0]*o+r,h-t[1]*o-a]})[0]}function h(t,e,n,r,a,o,h){return i(e,n,t).map(function(t){return[t[0]*o+r,h-t[1]*o-a]})}function s(t,e){var n=e.features.filter(function(e){return e.properties.name===t});if(n.length)return n[0].properties}function c(){var t="devicePixelRatio";return t in A&&A[t]>1?A[t]:1}function u(t,e,n){var r=X.createElement("canvas");return r.width=t*n,r.height=e*n,r.style.width=t+"px",r.style.height=e+"px",r.getContext("2d").scale(n,n),r}function f(t){var e=this.mapCanvas.getBoundingClientRect();this.mouseX=(t.clientX-e.left)*this.mapCanvas.width/e.width,this.mouseY=(t.clientY-e.top)*this.mapCanvas.height/e.height,this.updateMap()}function l(t){var e=this,n=this;["mousemove","click"].forEach(function(t){return A.addEventListener(t,f.bind(e),!1)}),this.layers.some(function(t){return t.animate})&&A.requestAnimationFrame(function t(){n.updateMap(),A.requestAnimationFrame(t)})}function m(t,e){var n=this.renderConf,r=h(t,n.minX,n.minY,n.offsetX,n.offsetY,n.areaScale,this.height);this.ctx.fillStyle=this.color,this.ctx.strokeStyle=this.borderColor,v(this.ctx,r),this.ctx.stroke(),this.callLayer("afterAreaDraw",r,e);var i=this.ctx.isPointInPath(this.mouseX,this.mouseY);return i&&(this.callLayer("onAreaHover",r,e),this.hoverName!==e.name&&(null!==this.hoverName&&this.callLayer("onAreaLeave",e),this.callLayer("onAreaEnter",e),this.hoverName=e.name)),i}function d(t){var e=this.renderConf;return o(t,e.minX,e.minY,e.offsetX,e.offsetY,e.areaScale,this.height)}function v(t,e){e.forEach(function(n,r){var i=[e[r][0],e[r][1]],a=i[0],o=i[1];0===r&&t.beginPath(),t.lineTo(a,o)}),t.closePath(),t.fill()}function p(t,e,n){var r="string"==typeof this.el?X.querySelector(this.el):this.el;if(!r)throw new Error("[Sinomap] Target element not found.");this.mouseX=0,this.mouseY=0,this.hoverName=null,this.canvasScale=c(),this.mapCanvas=u(this.width,this.height,this.canvasScale),this.ctx=this.mapCanvas.getContext("2d"),this.utils={drawPath:v,convert:d.bind(this)},r.appendChild(this.mapCanvas),l.call(this,this.mapCanvas)}function y(){var t=m.bind(this);this.renderConf=a(this.geoJSON,this.width,this.height);var e=!1;this.geoJSON.features.forEach(function(n){"Polygon"===n.geometry.type?n.geometry.coordinates.forEach(function(r){t(r,n.properties)&&(e=!0)}):n.geometry.coordinates.forEach(function(r){return r.forEach(function(r){t(r,n.properties)&&(e=!0)})})}),e||null===this.hoverName||(this.callLayer("onAreaLeave",s(this.hoverName,this.geoJSON)),this.hoverName=null),this.callLayer("afterMapDraw")}function g(){var t=this,e=Array.from(arguments),n=e.splice(0,1);this.layers.forEach(function(r){r[n]&&r[n].apply(r,[t].concat(C(e)))})}var w=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},E=function(){function t(t,e){var n=[],r=!0,i=!1,a=void 0;try{for(var o,h=t[Symbol.iterator]();!(r=(o=h.next()).done)&&(n.push(o.value),!e||n.length!==e);r=!0);}catch(t){i=!0,a=t}finally{try{!r&&h.return&&h.return()}finally{if(i)throw a}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),C=function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)},S=6378137,b=85.0511287798,x=Math.PI/180,A=window,X=document,Y={el:null,width:600,height:400,layers:[],color:"#ddd",borderColor:"white",geoJSON:null},M=function t(e){var n=this;w(this,t),this.updateMap=y.bind(this),this.callLayer=g.bind(this),e=Object.assign({},Y,e),Object.keys(e).forEach(function(t){n[t]=e[t]}),p.call(this),this.updateMap()};return"undefined"!=typeof module&&(module.exports=M),M}();
